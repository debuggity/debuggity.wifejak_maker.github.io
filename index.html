<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-45Q16ZPX5L"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-45Q16ZPX5L');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wifejak Maker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
            box-sizing: border-box;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #234161 #f0f0f0; /* Thumb color and track color */
        }

        /* Webkit Browsers (Chrome, Safari, etc.) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbar */
        }

        ::-webkit-scrollbar-track {
            background: #f0f0f0; /* Background of the track */
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #273647; /* Scrollbar thumb color */
            border-radius: 5px;
            border: 2px solid #f0f0f0; /* Gives a padding-like effect */
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #21354b; /* Darker shade on hover */
        }

        .active {
            cursor: grabbing; /* Change the cursor when dragging */
            cursor: -webkit-grabbing;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1400px; /* Increased the max-width for wider layout */
            margin-top: 20px;
            gap: 20px; /* Added gap between control panels */
        }

        .control-panel {
            position: relative; /* Make control-panel the reference point for absolute positioning */
            flex: 1 1 calc(33% - 40px);
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
            border: 2px solid transparent;
            transition: border-color 0.3s;
            width: auto;
            max-width: none;
            box-sizing: border-box;
        }


        .control-panel:hover {
            border-color: #007bff;
        }
        .control-panel h3 {
            margin-top: 0;
        }
        .icon-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .character-icon-container, .background-icon-container {
            width: 50px;
            height: 50px;
            margin: 10px;
            overflow: hidden;
            display: inline-block;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .character-icon, .background-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }
        .color-picker {
            display: flex;
            align-items: center;
            margin: 10px 0;
            position: relative; /* Changed from center to flex-start for alignment */
        }

        .color-picker label {
            margin-right: 10px;
        }

        .color-picker input {
            width: 50px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 60px;
        }

        canvas {
            border: 1px solid #ccc;
            border-radius: 10px;
            margin: 10px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .scale-slider {
            margin-top: 10px;
        }
        .scale-slider label {
            margin-right: 10px;
        }
        .scale-slider input {
            width: 100%;
        }
        .accessory-icon-container {
            width: 50px; /* Adjust width if needed */
            height: 50px; /* Adjust height if needed */
            overflow: hidden;
            display: inline-block;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-right: 10px; /* Ensure the gap between icons is correct */
        }

        .accessory-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        #removeAccessoriesBtn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        #removeAccessoriesBtn:hover {
            background-color: #cc0000;
        }
        .accessories-wrapper {
            overflow-x: auto; /* This might be changed or kept based on your design needs */
            display: flex;
            justify-content: flex-start; /* Changed from center to flex-start for alignment */
            flex-wrap: wrap; /* Allow items to wrap into the next line */
            align-items: center;
            margin-bottom: 10px;
            width: 105%; /* Adjusted to full width to accommodate more space */
            height: 220px; /* Enough height for two rows, adjust based on actual size needs */
            white-space: nowrap; /* This can be removed as we are now wrapping items */
            padding-bottom: 10px; /* To ensure the scrollbar does not hide the content */
        }

        .filters-wrapper, .accessories-wrapper {
            overflow-x: auto; /* Ensure horizontal scrolling is enabled */
            overflow-y: auto; /* Ensure vertical scrolling is visible if needed */
            white-space: nowrap; /* Prevent items from wrapping */
            display: flex; /* Ensure this is set to flex for inline layout */
            flex-wrap: wrap; /* Allow wrapping */
            gap: 5px; /* Maintain gap between items */
            padding: 0px; /* Adjust padding for internal spacing */
            width: 650px;
        }

        .horizontal-scroll-container {
            overflow-x: auto; /* Ensure horizontal scrolling is enabled */
            overflow-y: auto; /* Ensure vertical scrolling is visible if needed */
            white-space: nowrap; /* Prevent items from wrapping */
            display: flex; /* Ensure this is set to flex for inline layout */
            flex-wrap: wrap; /* Allow wrapping */
            gap: 5px; /* Maintain gap between items */
            padding: 0px; /* Adjust padding for internal spacing */
            width: 200px;
            min-width: 650px;
            min-height: 120px;
        }

        button#saveBtn {
            background-color: transparent;
            color: #333;
            border: none;
            cursor: pointer;
            font-size: 2em;
            position: fixed; /* Ensure it is fixed */
            top: 20px; /* Position it 20px from the top */
            right: 20px; /* Position it 20px from the right */
            z-index: 1000; /* Ensure it stays on top of other elements */
        }

        button#saveBtn:hover {
            color: #007bff;
        }

        #saveBtnBottom {
            background-color: transparent;
            color: #333;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 2em;
            margin-top: 10px;
        }

        #saveBtnBottom:hover {
            background-color: #0057b333;
        }


        .random-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ffc107;
            border: none;
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            font-size: 1.5em;
            transform: translateY(-33%) scale(0.8);
            transition: transform 0.2s;
        }

        .random-btn:hover {
            transform: translateY(-33%) scale(.9);
        }

        #resetBtn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        #resetBtn:hover {
            background-color: #cc0000;
        }
        #saveBtnBottom {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        #saveBtnBottom:hover {
            background-color: #0056b3;
        }

        @keyframes gigaRandomHearts {
            0% {
                transform: translateY(0) scale(1.5); /* Increased initial scale */
                opacity: 1;
            }
            100% {
                transform: translateY(-200px) scale(2); /* Increased final scale */
                opacity: 0;
            }
        }


        #gigaRandomBtn {
            background-color: #007bff;
            color: white;
            border: 2px solid transparent;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            margin-left: 10px; /* Adjust this value for spacing */
            position: relative;
            z-index: 1;
            overflow: visible; /* Change to visible to allow hearts to overflow */
        }

        #gigaRandomBtn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #gigaRandomBtn:hover::before {
            opacity: 1;
            background-size: 200% 200%;
            animation: rainbowBorder 2s linear infinite;
        }

        #gigaRandomBtn:active {
            animation: rainbowBorder 2s linear infinite;
        }

        @keyframes rainbowBorder {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        #heartContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999; /* Ensure it stays on top of other elements */
        }

        .heart {
            position: absolute;
            width: 40px; /* Increased width */
            height: 40px; /* Increased height */
            background-image: url('heart.png'); /* Ensure you have a heart.png image */
            background-size: contain;
            opacity: 1;
            animation: gigaRandomHearts 2s forwards; /* Adjust duration for longer float */
            pointer-events: none;
            z-index: 10000; /* Ensure hearts are on top */
        }




        #filters {
            display: flex; /* Ensure this is set to flex for inline layout */
            overflow-x: auto; /* Enable horizontal scrolling */
            gap: 5px; /* Maintain gap between items */
            padding: 5px; /* Adjust padding for internal spacing */
            white-space: nowrap; /* Prevent line breaks */
            height: 100px;
            width: 215px;
        }
        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            margin: 0 10px;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            border-bottom: 2px solid white;
        }


        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }



        #saveBtnTop {
            background-color: transparent;
            color: #333;
            border: none;
            cursor: pointer;
            font-size: 2em;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        #saveBtnTop:hover {
            color: #007bff;
        }

        @keyframes rainbowBorder {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Add these styles to the existing CSS */
        #default-characters, #special-characters {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            width: 100%;
            max-width: 650px;
        }

        .character-icon-container {
            flex: 0 0 auto; /* Ensure the item does not shrink or grow */
            width: 50px; /* Fixed width for each icon container */
            height: 50px; /* Fixed height for each icon container */
            margin: 10px; /* Space between icons */
            overflow: hidden; /* Hide any overflow content */
            display: inline-block; /* Display inline-block for layout */
            border-radius: 5px; /* Rounded corners */
            border: 1px solid #ccc; /* Border for each icon */
        }

        /* Character icon styling */
        .character-icon {
            width: 100%; /* Fill the container */
            height: 100%; /* Fill the container */
            object-fit: contain; /* Maintain aspect ratio */
            cursor: pointer; /* Pointer cursor for interactivity */
        }

        /* Main container layout */
        .main-container {
            display: flex;
            flex-direction: column; /* Default to vertical layout */
            align-items: center;
            width: 100%;
            max-width: 1200px; /* Adjust as needed */
            margin: 0 auto; /* Center on the page */
        }

        /* Default vertical layout for smaller screens */
        .tabs-and-canvas {
            width: 100%;
            display: flex;
            flex-direction: column; /* Stack tabs and canvas vertically */
            align-items: center;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            max-width: 1400px; /* Increased max-width for the wider layout */
            padding: 0 20px; /* Added padding to control container */
            gap: 20px; /* Space between the controls */
        }



        @media (max-width: 1200px) {
            body {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }
        @media (max-width: 1000px) {
            body {
                transform: scale(0.7);
                transform-origin: top center;
            }
        }


        @media (max-width: 768px) {
            .controls {
                flex-wrap: wrap; /* Allow the controls to wrap to the next line */
                justify-content: center; /* Center the controls horizontally */
            }

            .control-panel {
                width: 100%; /* Take full width of the screen */
                margin: 10px 0; /* Adjust margins to create space between panels */
            }

            canvas {
                width: 100%;
                height: auto; /* Maintain aspect ratio */
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-panel {
                margin: 10px 0;
            }

            h1 {
                font-size: 1.5em;
            }

            button {
                font-size: 0.9em;
                padding: 8px 16px;
            }

            .control-panel h3 {
                font-size: 1.2em;
            }

            
        }

</style>

    </style>
</head>
<body>

    <h1>❤️ Meet Your Wifejak ❤️</h1>
    <button id="saveBtn" style="position: absolute; top: 20px; right: 20px;">
        &#x1F4BE; <!-- This is a floppy disk icon representing save -->
    </button>

    <div class="main-container">
        <canvas id="characterCanvas" width="650" height="650" style="position: relative; z-index: 1;"></canvas>


        <div id="heartContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></div>

        <div id="main-tab-container" class="tab-container">
            <button class="tab-button" onclick="showTab('simple')">Simple Mode</button>
            <button class="tab-button" onclick="showTab('advanced')">Advanced Mode</button>
        </div>        

        <div class="tabs-and-canvas">

            <div id="simple-mode" class="tab-content active">
                <button id="saveBtn" style="position: absolute; top: 20px; right: 20px;">
                    &#x1F4BE;
                </button>
                <button id="gigaRandomBtn" onclick="gigaRandom()">Giga Random</button>
                <button id="saveBtnBottom" onclick="saveCharacter()">
                    &#x1F4BE;
                </button>
                <div id="heartContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></div>

                <!-- Add any other small important features here -->
            </div>

            <div id="advanced-mode" class="tab-content">

                <div class="tab-container">
                    <button class="tab-button" onclick="showAdvancedTab('character')">Character</button>
                    <button class="tab-button" onclick="showAdvancedTab('colors')">Colors</button>
                    <button class="tab-button" onclick="showAdvancedTab('filters')">Filters</button>
                    <button class="tab-button" onclick="showAdvancedTab('accessories')">Accessories</button>
                    <button class="tab-button" onclick="showAdvancedTab('background')">Background</button>
                </div>        

                <div id="character-tab" class="control-panel tab-content">
                    <h3>Select Your Character</h3>
                    <div id="default-characters" class="icon-container">
                        <div class="character-icon-container">
                            <img src="regular.png" alt="Default Character 1" class="character-icon" onclick="selectCharacter('regular.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="very-happy.png" alt="Default Character 2" class="character-icon" onclick="selectCharacter('very-happy.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="celebrating.png" alt="Default Character 3" class="character-icon" onclick="selectCharacter('celebrating.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="crying.png" alt="Default Character 4" class="character-icon" onclick="selectCharacter('crying.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="hands-up.png" alt="Default Character 5" class="character-icon" onclick="selectCharacter('hands-up.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="commando.png" alt="Default Character 6" class="character-icon" onclick="selectCharacter('commando.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="blushing.png" alt="Default Character 5" class="character-icon" onclick="selectCharacter('blushing.png')">
                        </div>
                        <div class="character-icon-container">
                            <img src="eye-roll.png" alt="Default Character 6" class="character-icon" onclick="selectCharacter('eye-roll.png')">
                        </div>
                    </div>
                    <h3>Special Wifejak's</h3>
                    <div id="special-characters" class="icon-container">
                        <div class="character-icon-container">
                            <img src="specials/apu.png" alt="Special Character 1" class="character-icon" onclick="selectCharacter('specials/apu.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/artist.png" alt="Special Character 2" class="character-icon" onclick="selectCharacter('specials/artist.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/astronaut.png" alt="Special Character 3" class="character-icon" onclick="selectCharacter('specials/astronaut.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/chef.png" alt="Special Character 4" class="character-icon" onclick="selectCharacter('specials/chef.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/crying.png" alt="Special Character 5" class="character-icon" onclick="selectCharacter('specials/crying.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/goblin.png" alt="Special Character 6" class="character-icon" onclick="selectCharacter('specials/goblin.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/goth.png" alt="Special Character 7" class="character-icon" onclick="selectCharacter('specials/goth.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/hiker.png" alt="Special Character 8" class="character-icon" onclick="selectCharacter('specials/hiker.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/kiss.png" alt="Special Character 9" class="character-icon" onclick="selectCharacter('specials/kiss.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/pearl.png" alt="Special Character 10" class="character-icon" onclick="selectCharacter('specials/pearl.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/princess.png" alt="Special Character 11" class="character-icon" onclick="selectCharacter('specials/princess.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/scuba.png" alt="Special Character 12" class="character-icon" onclick="selectCharacter('specials/scuba.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/shushing.png" alt="Special Character 13" class="character-icon" onclick="selectCharacter('specials/shushing.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/worker.png" alt="Special Character 14" class="character-icon" onclick="selectCharacter('specials/worker.png', true)">
                        </div>
                        <div class="character-icon-container">
                            <img src="specials/zelda.png" alt="Special Character 15" class="character-icon" onclick="selectCharacter('specials/zelda.png', true)">
                        </div>
                        <!-- Add more special characters here -->
                    </div>

                    <label for="fileInput">Select Character Image:</label>
                    <input type="file" id="fileInput" accept="image/png">
                    <div class="scale-slider">
                        <label for="scaleRange">Scale Character:</label>
                        <input type="range" id="scaleRange" min="0.5" max="1.2" step="0.05" value="1">
                    </div>
                    <button class="random-btn" onclick="randomizeCharacter()">🎲</button>
                </div>

                <div id="colors-tab" class="control-panel tab-content">
                    <h3>Color Customization</h3>
                    <div class="color-picker">
                        <label for="skinColor">Skin Color:</label>
                        <button class="random-btn" onclick="randomizeColor('skinColor')">🎲</button>
                        <input type="color" id="skinColor" value="#f7e8e8">
                    </div>
                    <div class="color-picker">
                        <label for="hairColor">Hair Color:</label>
                        <button class="random-btn" onclick="randomizeColor('hairColor')">🎲</button>
                        <input type="color" id="hairColor" value="#8e2a2a">
                    </div>
                    <div class="color-picker">
                        <label for="shirtColor">Shirt Color:</label>
                        <button class="random-btn" onclick="randomizeColor('shirtColor')">🎲</button>
                        <input type="color" id="shirtColor" value="#808080">
                    </div>
                    <div class="color-picker">
                        <label for="bgColor">Background:</label>
                        <button class="random-btn" onclick="randomizeColor('bgColor')">🎲</button>
                        <input type="color" id="bgColor" value="#ab84e6">
                    </div>
                    <button id="resetBtn">Reset to Default</button>
                </div>


                <div id="filters-tab" class="control-panel tab-content">
                    <!-- New section for image filters -->
                    <h3>Select Image Filter</h3>
                    <div class="filters-wrapper">
                        <div id="filters" class="horizontal-scroll-container">
                            <div class="filter-icon-container" style="width: 50px; height: 50px; overflow: hidden; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; text-align: center; line-height: 50px; font-size: 24px; cursor: pointer;">
                                <span onclick="removeFilter()">❌</span>
                            </div>
                                                
                            <div class="filter-icon-container" style="width: 50px; height: 50px; overflow: hidden; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px;">
                                <img src="filters/old-timey.png" alt="Old Timey Filter" class="filter-icon" onclick="applyFilter('old-timey')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);" onclick="applyFilter('vintage')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);" onclick="applyFilter('retro')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: linear-gradient(135deg, #ffffff 0%, #2b282b 100%);" onclick="applyFilter('black-and-white')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);" onclick="applyFilter('sepia')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);" onclick="applyFilter('cool')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: linear-gradient(135deg, #ffffff 0%, #0b374b 100%);" onclick="applyFilter('manga')">
                            </div>
                            <div class="filter-icon-container" style="width: 50px; height: 50px; display: inline-block; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; background: radial-gradient(circle, transparent 70%, black 100%);" onclick="applyFilter('vignette')">
                            </div>   
                            <!-- Add more filter icons here -->
                        </div>
                    </div>
                        
                </div>


                <div id="accessories-tab" class="control-panel tab-content">
                    <h3>Select Accessories</h3>
                    <button class="random-btn" onclick="randomizeAccessory()">🎲</button>
                    <div class="accessories-wrapper">
                        <div id="accessories" class="horizontal-scroll-container">
                            <div class="accessory-icon-container">
                                <img src="accessories/sunglasses_1.png" alt="Accessory 1" class="accessory-icon" 
                                    data-percent-x="42.5" data-percent-y="36" data-scale="0.32" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/sunglasses_2.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="41.5" data-percent-y="35" data-scale="0.32" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/sunglasses_3.png" alt="Accessory 1" class="accessory-icon" 
                                    data-percent-x="41.5" data-percent-y="35" data-scale="0.32" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/sunglasses_4.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="41.5" data-percent-y="35" data-scale="0.32" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_1.png" alt="Accessory 1" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="4.5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_2.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="4.5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_3.png" alt="Accessory 1" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_4.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="4.5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_5.png" alt="Accessory 1" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="6" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_6.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="4.5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_7.png" alt="Accessory 1" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="4.5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_8.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="4.5" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_floki.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="24" data-percent-y="-2.5" data-scale="0.62" data-angle="-5" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/hat_wif.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="25" data-percent-y="10.5" data-scale="0.45" data-angle="-13" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/beachball.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="60" data-percent-y="74" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/flipflops.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="60" data-percent-y="74" data-scale="0.3" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/starfish.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="30" data-percent-y="27" data-scale="0.18" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/surfboard.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="10" data-percent-y="30" data-scale="0.8" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>
                            <div class="accessory-icon-container">
                                <img src="accessories/surfboard2.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="10" data-percent-y="30" data-scale="0.8" data-angle="-17" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/mcdonalds_cap.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="30.5" data-percent-y="15" data-scale="0.45" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/BONK.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="54" data-percent-y="62" data-scale="0.5" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>   
                            <div class="accessory-icon-container">
                                <img src="accessories/DOGE.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="52" data-percent-y="66" data-scale="0.4" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>   
                            <div class="accessory-icon-container">
                                <img src="accessories/SHIB.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="52" data-percent-y="68" data-scale="0.35" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>   
                            <div class="accessory-icon-container">
                                <img src="accessories/WIF.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="52" data-percent-y="68" data-scale="0.35" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>   
                            <div class="accessory-icon-container">
                                <img src="accessories/PEPE.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="26.3" data-percent-y="8" data-scale="0.4" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>   
                            <div class="accessory-icon-container">
                                <img src="accessories/FLOKI.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="52" data-percent-y="63" data-scale="0.4" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>      
                            <div class="accessory-icon-container">
                                <img src="accessories/bird_hand.PNG" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/blue-bow.PNG" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/pink-bow.PNG" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/pink-bow-2.PNG" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/lanterns.png" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/sword.PNG" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>    
                            <div class="accessory-icon-container">
                                <img src="accessories/umbrella.PNG" alt="Accessory 2" class="accessory-icon" 
                                    data-percent-x="0" data-percent-y="0" data-scale="1" data-angle="0" 
                                    onclick="selectAccessory(this)">
                            </div>                  
                        </div>
                    </div>
                    <button id="removeAccessoriesBtn" onclick="removeAllAccessories()">Remove All Accessories</button>    
                </div>        
                    
                <div id="background-tab" class="control-panel tab-content">
                    <h3>Select Your Background</h3>
                    <button class="random-btn" onclick="randomizeBackground()">🎲</button>
                    <div id="preset-backgrounds" class="icon-container">
                        <div class="background-icon-container" style="text-align: center; line-height: 50px; font-size: 24px; cursor: pointer;">
                            <span onclick="removeBackground()">❌</span>
                        </div>
                        
                        <div class="background-icon-container">
                            <img src="bg1.png" alt="Preset Background 1" class="background-icon" onclick="selectBackground('bg1.png')">
                        </div>
                        <div class="background-icon-container">
                            <img src="bg2.png" alt="Preset Background 2" class="background-icon" onclick="selectBackground('bg2.png')">
                        </div>
                        <div class="background-icon-container">
                            <img src="bg3.png" alt="Preset Background 3" class="background-icon" onclick="selectBackground('bg3.png')">
                        </div>
                        <div class="background-icon-container">
                            <img src="bg4.png" alt="Preset Background 4" class="background-icon" onclick="selectBackground('bg4.png')">
                        </div>
                        <div class="background-icon-container">
                            <img src="bg5.png" alt="Preset Background 5" class="background-icon" onclick="selectBackground('bg5.png')">
                        </div>
                        <div class="background-icon-container">
                            <img src="bg6.png" alt="Preset Background 6" class="background-icon" onclick="selectBackground('bg6.png')">
                        </div>
                        
                    </div>
                    <label for="bgFileInput">Select Background Image:</label>
                    <input type="file" id="bgFileInput" accept="image/png, image/jpeg">
                    <br><br><br>
                    <h3>Extras...</h3>
                    <button id="saveBtnBottom" onclick="saveCharacter()">
                        &#x1F4BE;
                    </button>
                    <button id="gigaRandomBtn" onclick="gigaRandom()">Giga Random</button> <!-- Add this line -->
                </div>
            </div>
        </div>
    </div>
    <script>
        const fileInput = document.getElementById('fileInput');
        const bgFileInput = document.getElementById('bgFileInput');
        const skinColorInput = document.getElementById('skinColor');
        const hairColorInput = document.getElementById('hairColor');
        const shirtColorInput = document.getElementById('shirtColor');
        const bgColorInput = document.getElementById('bgColor');
        const saveBtn = document.getElementById('saveBtn');
        const canvas = document.getElementById('characterCanvas');
        const ctx = canvas.getContext('2d');

        function showTab(tabName) {
            // Hide all tab contents for simple and advanced mode
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons for simple and advanced mode
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content
            document.getElementById(`${tabName}-mode`).classList.add('active');

            // Add active class to the selected tab button
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        
            if (tabName === "advanced") {
                showAdvancedTab("character")
            }
        }

        function showAdvancedTab(tabName) {
            // Hide all tab contents within advanced mode
            document.querySelectorAll('#advanced-mode .tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons within advanced mode
            document.querySelectorAll('#advanced-mode .tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content within advanced mode
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Add active class to the selected tab button within advanced mode
            document.querySelector(`#advanced-mode .tab-button[onclick="showAdvancedTab('${tabName}')"]`).classList.add('active');
        }

        // Show the character tab by default within advanced mode
        showAdvancedTab('character');

        // Show the simple mode by default
        showTab('simple');



        function removeFilter() {
            currentFilter = null;
            vignetteEnabled = false; // Also disable vignette if it's considered a filter
            drawCanvas();
        }

        function removeBackground() {
            useBgImage = false;
            bgColor = ''; // Optionally reset the background color
            drawCanvas();
        }



        let useBgImage = true; // Flag to track if a background image is used
        let bgColor = ''; // Variable to store the background color

        async function gigaRandom() {
            removeAllAccessories();
            randomizeCharacter();

            // 20% chance to remove the background image
            if (Math.random() < 0.25) {
                useBgImage = false;
                rouletteBackgroundColorChange();
            } else {
                useBgImage = true;
                randomizeBackground();
                //randomizeColor('bgColor');
            }

            randomizeColor('skinColor');
            randomizeColor('hairColor');
            randomizeColor('shirtColor');

            // Generate a random number between 0 and 3 for the number of accessories to add
            const numAccessories = Math.floor(Math.random() * 4);
            for (let i = 0; i < numAccessories; i++) {
                await randomizeAccessory();
            }

            generateHearts(); // Generate animated hearts
            drawCanvas(); // Ensure the canvas is updated
        }

        // Function to generate animated hearts
        function generateHearts() {
            const heartContainer = document.getElementById('heartContainer');
            const canvasRect = canvas.getBoundingClientRect();

            // Clear any existing hearts
            while (heartContainer.firstChild) {
                heartContainer.removeChild(heartContainer.firstChild);
            }

            // Generate new hearts
            for (let i = 0; i < 10; i++) {
                const heart = document.createElement('div');
                heart.classList.add('heart');
                heart.style.left = `${canvasRect.left + Math.random() * canvas.width}px`; // Use canvas position and width for positioning
                heart.style.top = `${canvasRect.top + canvas.height}px`; // Start from the bottom of the canvas
                heart.style.animationDelay = `${Math.random() * 0.5}s`;
                heartContainer.appendChild(heart);

                // Remove heart after animation completes
                heart.addEventListener('animationend', () => {
                    heartContainer.removeChild(heart);
                });
            }
        }

        function rouletteBackgroundColorChange() {
            let steps = 15; // Number of steps for the roulette animation
            let stepDuration = 150; // Duration of each step in milliseconds

            let interval = setInterval(() => {
                let randomColor = getRandomColor();
                bgColor = randomColor; // Update the bgColor variable
                drawCanvas(); // Redraw the canvas with the new color
            }, stepDuration);

            setTimeout(() => {
                clearInterval(interval);
                // Final random color
                let finalColor = getRandomColor();
                bgColor = finalColor; // Update the bgColor variable
                drawCanvas(); // Redraw the canvas to apply the final color change
            }, steps * stepDuration);
        }

        const resetBtn = document.getElementById('resetBtn');

        resetBtn.addEventListener('click', () => {
            // Reset color inputs to default values
            skinColorInput.value = '#f7e8e8';
            hairColorInput.value = '#8e2a2a';
            shirtColorInput.value = '#808080';
            bgColorInput.value = '#ab84e6';
            bgColor = bgColorInput.value

            // Reset the current filter to null
            currentFilter = null;
            vignetteEnabled = false;

            drawCanvas();
        });

        function randomizeCharacter() {
            const defaultCharacterImages = [
                'regular.png', 
                'very-happy.png', 
                'celebrating.png', 
                'crying.png', 
                'hands-up.png', 
                'commando.png', 
                'blushing.png', 
                'eye-roll.png'
            ];
            const specialCharacterImages = [
                'specials/apu.png',
                'specials/artist.png',
                'specials/astronaut.png',
                'specials/chef.png',
                'specials/crying.png',
                'specials/goblin.png',
                'specials/goth.png',
                'specials/hiker.png',
                'specials/kiss.png',
                'specials/pearl.png',
                'specials/princess.png',
                'specials/scuba.png',
                'specials/shushing.png',
                'specials/worker.png',
                'specials/zelda.png'
            ];

            const allCharacterImages = [
                ...defaultCharacterImages.map(img => ({ path: img, isSpecial: false })),
                ...specialCharacterImages.map(img => ({ path: img, isSpecial: true }))
            ];

            rouletteAnimation(allCharacterImages, ({ path, isSpecial }) => selectCharacter(path, isSpecial));
        }

        function rouletteAnimation(options, callback) {
            let index = 0;
            const interval = setInterval(() => {
                callback(options[index]);
                index = (index + 1) % options.length;
            }, 100);

            setTimeout(() => {
                clearInterval(interval);
                const finalChoice = options[Math.floor(Math.random() * options.length)];
                callback(finalChoice);
            }, 2000); // Duration of the roulette effect
        }

        function randomizeBackground() {
            useBgImage = true; // Set the flag to true since a background image is used
            const backgroundImages = ['bg1.png', 'bg2.png', 'bg3.png', 'bg4.png', 'bg5.png', 'bg6.png'];
            rouletteAnimation(backgroundImages, selectBackground);
        }

        function isOverlapping(newAccessory) {
            const overlapThreshold = 0.2; // Allow up to 30% overlap

            for (const accessory of accessories) {
                const newAccessoryBounds = getAccessoryBounds(newAccessory);
                const existingAccessoryBounds = getAccessoryBounds(accessory);

                const overlapX = Math.max(0, Math.min(newAccessoryBounds.x + newAccessoryBounds.width, existingAccessoryBounds.x + existingAccessoryBounds.width) - Math.max(newAccessoryBounds.x, existingAccessoryBounds.x));
                const overlapY = Math.max(0, Math.min(newAccessoryBounds.y + newAccessoryBounds.height, existingAccessoryBounds.y + existingAccessoryBounds.height) - Math.max(newAccessoryBounds.y, existingAccessoryBounds.y));
                
                const overlapArea = overlapX * overlapY;
                const newAccessoryArea = newAccessoryBounds.width * newAccessoryBounds.height;

                if (overlapArea / newAccessoryArea > overlapThreshold) {
                    return true; // There is too much overlap
                }
            }
            return false; // No significant overlap
        }

        function getAccessoryBounds(accessory) {
            const characterX = (canvas.width - characterImage.width * characterScale) / 2;
            const characterY = canvas.height - characterImage.height * characterScale;
            const x = characterX + (characterImage.width * characterScale * accessory.originalX) / 100;
            const y = characterY + (characterImage.height * characterScale * accessory.originalY) / 100;
            const { width, height } = getAccessoryImageDimensions(accessory.image, characterImage.width * characterScale * accessory.scale, characterImage.height * characterScale * accessory.scale);

            const centerX = x + width / 2;
            const centerY = y + height / 2;

            const corners = [
                { x: x, y: y },
                { x: x + width, y: y },
                { x: x + width, y: y + height },
                { x: x, y: y + height }
            ];

            const angle = accessory.angle * Math.PI / 180;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);

            const rotatedCorners = corners.map(corner => {
                const dx = corner.x - centerX;
                const dy = corner.y - centerY;
                return {
                    x: centerX + dx * cos - dy * sin,
                    y: centerY + dx * sin + dy * cos
                };
            });

            const xs = rotatedCorners.map(corner => corner.x);
            const ys = rotatedCorners.map(corner => corner.y);

            const minX = Math.min(...xs);
            const maxX = Math.max(...xs);
            const minY = Math.min(...ys);
            const maxY = Math.max(...ys);

            return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };
        }



        function randomizeAccessory() {
            return new Promise((resolve) => {
                cacheAccessoryElements(); // Reset accessory elements before starting the randomization process

                const maxRetries = 3; // Reduce the number of retries
                let retries = 0;

                const tryAddAccessory = () => {
                    if (retries >= maxRetries) {
                        console.log("Max retries reached, no suitable accessory found.");
                        resolve();
                        return;
                    }

                    retries++;
                    rouletteAnimationForAccessories(cachedAccessoryElements, (finalChoice) => {
                        const accessoryImage = new Image();
                        accessoryImage.src = finalChoice.src;

                        const tempAccessory = {
                            image: accessoryImage,
                            originalX: parseFloat(finalChoice.dataset.percentX),
                            originalY: parseFloat(finalChoice.dataset.percentY),
                            scale: parseFloat(finalChoice.dataset.scale),
                            angle: parseFloat(finalChoice.dataset.angle)
                        };

                        if (!isOverlapping(tempAccessory)) {
                            accessories.push(tempAccessory);
                            cachedAccessoryElements = cachedAccessoryElements.filter(el => el.src !== finalChoice.src); // Update cached elements
                            drawCanvas();
                            resolve();
                        } else {
                            tryAddAccessory(); // Retry if there's an overlap
                        }
                    });
                };

                tryAddAccessory();
            });
        }

        function rouletteAnimationForAccessories(options, callback) {
            let index = 0;
            let currentAccessory = null;

            const minDuration = 500; // Reduce minimum duration
            const maxDuration = 1500; // Reduce maximum duration
            const randomDuration = Math.floor(Math.random() * (maxDuration - minDuration + 1)) + minDuration;

            const interval = setInterval(() => {
                if (currentAccessory) {
                    removePreviewAccessory(currentAccessory);
                }
                currentAccessory = options[index];
                previewAccessory(currentAccessory, false);
                index = (index + 1) % options.length;
            }, 50); // Increase interval speed

            setTimeout(() => {
                clearInterval(interval);
                if (currentAccessory) {
                    removePreviewAccessory(currentAccessory);
                }
                const finalChoice = options[Math.floor(Math.random() * options.length)];
                callback(finalChoice);
            }, randomDuration);
        }



        function previewAccessory(element, isFinal) {
            const accessoryImage = new Image();
            accessoryImage.src = element.src;

            const tempAccessory = {
                image: accessoryImage,
                originalX: parseFloat(element.dataset.percentX),
                originalY: parseFloat(element.dataset.percentY),
                scale: parseFloat(element.dataset.scale),
                angle: parseFloat(element.dataset.angle)
            };

            // Temporarily add the selected accessory
            accessories.push(tempAccessory);
            drawCanvas();

            // If it's not the final accessory, remove it after a short delay
            if (!isFinal) {
                setTimeout(() => {
                    accessories = accessories.filter(accessory => accessory !== tempAccessory);
                    drawCanvas();
                }, 100); // Adjust the delay as needed for preview duration
            }
        }

        function removePreviewAccessory(element) {
            const accessoryImageSrc = element.src;
            accessories = accessories.filter(accessory => accessory.image.src !== accessoryImageSrc);
        }

        function randomizeColor(colorInputId) {
            const colorInput = document.getElementById(colorInputId);
            let steps = 15; // Number of steps for the roulette animation
            let stepDuration = 150; // Duration of each step in milliseconds

            let interval = setInterval(() => {
                let randomColor;
                if (colorInputId === 'skinColor' && Math.random() < 0.90) {
                    // 90% chance to choose a skin tone
                    randomColor = getRandomSkinTone();
                } else if (colorInputId === 'hairColor' && Math.random() < 0.85) {
                    // 85% chance to choose a beautiful hair color
                    randomColor = getRandomHairColor();
                } else if (colorInputId === 'bgColor') {
                    useBgImage = false;
                    randomColor = getRandomColor();
                    bgColor = randomColor;
                } else {
                    randomColor = getRandomColor();
                }
                colorInput.value = randomColor;
                drawCanvas();
            }, stepDuration);

            setTimeout(() => {
                clearInterval(interval);

                // Final random color
                let finalColor;
                if (colorInputId === 'skinColor' && Math.random() < 0.8) {
                    finalColor = getRandomSkinTone();
                } else if (colorInputId === 'hairColor' && Math.random() < 0.8) {
                    finalColor = getRandomHairColor();
                } else if (colorInputId === 'bgColor') {
                    finalColor = getRandomColor();
                    bgColor = finalColor
                } else {
                    finalColor = getRandomColor();
                }

                colorInput.value = finalColor;
                drawCanvas();
            }, steps * stepDuration);
        }

        function getRandomHairColor() {
            return hairColors[Math.floor(Math.random() * hairColors.length)];
        }


        function getRandomSkinTone() {
            const skinTones = [
                '#FFDFC4', // Light Caucasian
                '#F0D5BE', // Fair Caucasian
                '#FFDFC4', // Light Caucasian
                '#F0D5BE', // Fair Caucasian
                '#E1B899', // Beige Caucasian
                '#D1A36E', // Light Tan Caucasian
                '#D1A36E', // Light Tan Caucasian
                '#B48653', // Medium Tan Caucasian
                '#F3D1B8', // Light Peach
                '#ECD2B0', // Peach
                '#E6B89C', // Warm Beige
                '#F0C6A8', // Light Warm Beige
                '#FFDFC4', // Light Warm Caucasian
                '#E5B78B', // Soft Beige
                '#D9AB84', // Sandy Beige
                '#D8A98B', // Soft Tan
                '#C99473', // Medium Beige
                '#C08063', // Medium Peach
                '#AD7B5F', // Medium Warm
                '#9A6D4E', // Dark Beige
                '#8D5524', // Deep Tan Caucasian
                '#C68642', // Bronze Tan
                '#E0AC69', // Honey Beige
                '#F1C27D', // Golden Beige
                '#FFDBAC'  // Light Tan Caucasian
            ];

            return skinTones[Math.floor(Math.random() * skinTones.length)];
        }

        const hairColors = [
            '#2c2c2c', // Dark Brown
            '#654321', // Chestnut Brown
            '#8b4513', // Saddle Brown
            '#a52a2a', // Red Brown
            '#d2b48c', // Tan
            '#f4a460', // Sandy Brown
            '#c8a2c8', // Lilac
            '#ff4500', // Orange Red
            '#ffa500', // Orange
            '#ff8c00', // Dark Orange
            '#ffdab9', // Peach
            '#ff69b4', // Hot Pink
            '#ff1493', // Deep Pink
            '#800080', // Purple
            '#4b0082', // Indigo
            '#6a5acd', // Slate Blue
            '#483d8b', // Dark Slate Blue
            '#4169e1', // Royal Blue
            '#1e90ff', // Dodger Blue
            '#00ced1', // Dark Turquoise
            '#40e0d0', // Turquoise
            '#00ff7f', // Spring Green
            '#32cd32', // Lime Green
            '#7fff00', // Chartreuse
            '#8b4513', // Saddle Brown
            '#d2691e', // Chocolate
            '#ff6347', // Tomato
            '#cd5c5c', // Indian Red
            '#f08080', // Light Coral
            '#e9967a', // Dark Salmon
            '#fa8072', // Salmon
            '#ffa07a', // Light Salmon
        ];


        function getRandomColor() {
            const hue = Math.floor(Math.random() * 360); // Random hue value between 0 and 360
            const saturation = Math.floor(Math.random() * 41) + 60; // Random saturation between 60% and 100%
            const lightness = Math.floor(Math.random() * 31) + 40; // Random lightness between 40% and 70%
            
            return hslToHex(hue, saturation, lightness);
        }

        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            let c = (1 - Math.abs(2 * l - 1)) * s,
                x = c * (1 - Math.abs((h / 60) % 2 - 1)),
                m = l - c / 2,
                r = 0,
                g = 0,
                b = 0;
            if (0 <= h && h < 60) {
                r = c;
                g = x;
                b = 0;
            } else if (60 <= h && h < 120) {
                r = x;
                g = c;
                b = 0;
            } else if (120 <= h && h < 180) {
                r = 0;
                g = c;
                b = x;
            } else if (180 <= h && h < 240) {
                r = 0;
                g = x;
                b = c;
            } else if (240 <= h && h < 300) {
                r = x;
                g = 0;
                b = c;
            } else if (300 <= h && h < 360) {
                r = c;
                g = 0;
                b = x;
            }
            r = Math.round((r + m) * 255).toString(16).padStart(2, '0');
            g = Math.round((g + m) * 255).toString(16).padStart(2, '0');
            b = Math.round((b + m) * 255).toString(16).padStart(2, '0');

            return `#${r}${g}${b}`;
        }

        let accessories = [];

        let cachedAccessoryElements = null;

        function cacheAccessoryElements() {
            cachedAccessoryElements = Array.from(document.querySelectorAll('.accessory-icon')).filter(el => !accessories.some(acc => acc.image.src === el.src));
        }

        // Cache the accessory elements on page load
        cacheAccessoryElements();

        function selectAccessory(element) {
            const path = element.src;
            const percentX = parseFloat(element.dataset.percentX);
            const percentY = parseFloat(element.dataset.percentY);
            const scale = parseFloat(element.dataset.scale);
            const angle = parseFloat(element.dataset.angle);

            let accessoryImage = new Image();
            accessoryImage.src = path;
            accessoryImage.onload = () => {
                accessories.push({
                    image: accessoryImage,
                    originalX: percentX,
                    originalY: percentY,
                    scale: scale,
                    angle: angle
                });
                drawCanvas();
            };
        }

        let selectedAccessory = null;
        let interactionMode = 'drag'; // Default interaction mode
        let startX, startY;
        let initialAngle = 0;
        let initialMouseAngle = 0;
        let initialDistance = 0;

        function drawSelectionOutline(accessory, characterX, characterY, characterWidth, characterHeight) {
            const x = characterX + (characterWidth * accessory.originalX) / 100;
            const y = characterY + (characterHeight * accessory.originalY) / 100;
            const { width, height } = getAccessoryImageDimensions(accessory.image, characterWidth * accessory.scale, characterHeight * accessory.scale);

            const centerX = x + width / 2;
            const centerY = y + height / 2;

            // Calculate the corners of the rectangle
            const corners = [
                { x: x, y: y },
                { x: x + width, y: y },
                { x: x + width, y: y + height },
                { x: x, y: y + height }
            ];

            // Rotate the corners around the center
            const angle = accessory.angle * Math.PI / 180;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);

            const rotatedCorners = corners.map(corner => {
                const dx = corner.x - centerX;
                const dy = corner.y - centerY;
                return {
                    x: centerX + dx * cos - dy * sin,
                    y: centerY + dx * sin + dy * cos
                };
            });

            // Draw the rotated rectangle
            ctx.save();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(rotatedCorners[0].x, rotatedCorners[0].y);
            for (let i = 1; i < rotatedCorners.length; i++) {
                ctx.lineTo(rotatedCorners[i].x, rotatedCorners[i].y);
            }
            ctx.closePath();
            ctx.stroke();

            // Draw the text only if not rotating or scaling
            if (interactionMode !== 'rotate' && interactionMode !== 'scale') {
                // Calculate the top-middle point of the rotated rectangle for the text
                const topMiddleX = (rotatedCorners[0].x + rotatedCorners[1].x) / 2;
                const topMiddleY = (rotatedCorners[0].y + rotatedCorners[1].y) / 2;

                // Display the instructions text above the bounding box
                ctx.font = '16px Arial';
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.fillText('R: Rotate, S: Scale', topMiddleX, topMiddleY - 10);
            }

            ctx.restore();
        }




        // Add event listeners to the canvas
        canvas.addEventListener('mousedown', onMouseDown);
        canvas.addEventListener('mousemove', onMouseMove);
        canvas.addEventListener('mouseup', onMouseUp);

        function onMouseDown(event) {
            const { offsetX, offsetY } = event;
            selectedAccessory = getAccessoryAtPosition(offsetX, offsetY);
            if (selectedAccessory) {
                startX = offsetX;
                startY = offsetY;
                if (interactionMode === 'rotate') {
                    const centerX = (canvas.width - characterImage.width) / 2 + (characterImage.width * selectedAccessory.originalX) / 100;
                    const centerY = canvas.height - characterImage.height + (characterImage.height * selectedAccessory.originalY) / 100;
                    initialAngle = selectedAccessory.angle;
                    initialMouseAngle = Math.atan2(offsetY - centerY, offsetX - centerX);
                } else if (interactionMode === 'scale') {
                    const centerX = (canvas.width - characterImage.width) / 2 + (characterImage.width * selectedAccessory.originalX) / 100;
                    const centerY = canvas.height - characterImage.height + (characterImage.height * selectedAccessory.originalY) / 100;
                    initialDistance = Math.sqrt((offsetX - centerX) ** 2 + (offsetY - centerY) ** 2);
                }
            }
        }

        const MAX_ACCESSORY_SCALE = 2.0; // Define the maximum scale value for accessories

        function onMouseMove(event) {
            if (!selectedAccessory) return;

            const { offsetX, offsetY } = event;
            const dx = offsetX - startX;
            const dy = offsetY - startY;

            const characterX = (canvas.width - characterImage.width) / 2;
            const characterY = canvas.height - characterImage.height;
            const centerX = characterX + (characterImage.width * selectedAccessory.originalX) / 100;
            const centerY = characterY + (characterImage.height * selectedAccessory.originalY) / 100;

            if (interactionMode === 'drag') {
                selectedAccessory.originalX += (dx / canvas.width) * 100;
                selectedAccessory.originalY += (dy / canvas.height) * 100;
                startX = offsetX;
                startY = offsetY;
            } else if (interactionMode === 'rotate') {
                const currentMouseAngle = Math.atan2(offsetY - centerY, offsetX - centerX);
                const angleDifference = currentMouseAngle - initialMouseAngle;
                selectedAccessory.angle = initialAngle + angleDifference * (180 / Math.PI);
            } else if (interactionMode === 'scale') {
                const currentDistance = Math.sqrt((offsetX - centerX) ** 2 + (offsetY - centerY) ** 2);
                const scaleChange = currentDistance / initialDistance;
                selectedAccessory.scale = Math.min(MAX_ACCESSORY_SCALE, Math.max(0.1, selectedAccessory.scale * scaleChange)); // Ensure the scale doesn't exceed the maximum
                initialDistance = currentDistance;
            }

            drawCanvas();
        }


        function onMouseUp() {
            selectedAccessory = null;
            interactionMode = 'drag'; // Reset to default interaction mode
            drawCanvas(); // Redraw the canvas to remove the selection outline
        }

        // Function to get accessory at mouse position
        const getAccessoryAtPosition = (x, y) => {
            const characterX = (canvas.width - characterImage.width * characterScale) / 2;
            const characterY = canvas.height - characterImage.height * characterScale;

            for (const accessory of accessories) {
                const accessoryX = characterX + (characterImage.width * characterScale * accessory.originalX) / 100;
                const accessoryY = characterY + (characterImage.height * characterScale * accessory.originalY) / 100;
                const { width, height } = getAccessoryImageDimensions(accessory.image, characterImage.width * characterScale * accessory.scale, characterImage.height * characterScale * accessory.scale);

                if (isPointInRotatedRect(x, y, accessoryX, accessoryY, width, height, accessory.angle)) {
                    return accessory;
                }
            }
            return null;
        };


        function isPointInRotatedRect(px, py, rx, ry, rw, rh, angle) {
            // Convert angle to radians
            const rad = angle * Math.PI / 180;
            const cos = Math.cos(rad);
            const sin = Math.sin(rad);

            // Calculate the center of the rectangle
            const cx = rx + rw / 2;
            const cy = ry + rh / 2;

            // Translate the point to the rectangle's coordinate system
            const translatedX = px - cx;
            const translatedY = py - cy;

            // Rotate the point back
            const rotatedX = translatedX * cos + translatedY * sin;
            const rotatedY = -translatedX * sin + translatedY * cos;

            // Translate the point back to the original coordinate system
            const localX = rotatedX + rw / 2;
            const localY = rotatedY + rh / 2;

            // Check if the point is within the bounds of the rectangle
            return localX >= 0 && localX <= rw && localY >= 0 && localY <= rh;
        }


        document.addEventListener('keydown', (event) => {
            if (event.key === 'r') {
                interactionMode = 'rotate';
            } else if (event.key === 's') {
                interactionMode = 'scale';
            } else if (event.key === 'd') {
                interactionMode = 'drag';
            }
        });

        document.addEventListener('keyup', (event) => {
            if (event.key === 'r' || event.key === 's') {
                interactionMode = 'drag';
            }
        });




        const drawAccessories = (characterX, characterY, characterWidth, characterHeight, accessoriesToDraw) => {
            accessoriesToDraw.forEach(accessory => {
                const x = characterX + (characterWidth * accessory.originalX) / 100;
                const y = characterY + (characterHeight * accessory.originalY) / 100;
                const { width, height } = getAccessoryImageDimensions(accessory.image, characterWidth * accessory.scale, characterHeight * accessory.scale);

                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(x + width / 2, y + height / 2);
                ctx.rotate(accessory.angle * Math.PI / 180);
                ctx.drawImage(accessory.image, -width / 2, -height / 2, width, height);
                ctx.restore();
            });
        };



        const getAccessoryImageDimensions = (image, maxWidth, maxHeight) => {
            const aspectRatio = image.width / image.height;

            let width, height;
            if (maxWidth / maxHeight > aspectRatio) {
                height = maxHeight;
                width = height * aspectRatio;
            } else {
                width = maxWidth;
                height = width / aspectRatio;
            }
            return { width, height };
        };

        function removeAllAccessories() {
            accessories = [];
            drawCanvas();
        }

        let characterImage = new Image();
        let bgImage = new Image();
        let originalPixels, imageData;
        let offscreenCanvas = document.createElement('canvas');
        let offscreenCtx = offscreenCanvas.getContext('2d');

        // Initial canvas size setup
        canvas.width = 650;
        canvas.height = 650;

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    characterImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        bgFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && (file.type === 'image/png' || file.type === 'image/jpeg')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bgImage.src = e.target.result;
                    bgImage.onload = drawCanvas;
                };
                reader.readAsDataURL(file);
            }
        });

        // JavaScript: Handle Character Selection and Upload

        // Function to select a default character
        function selectCharacter(characterPath, isSpecial) {
            characterImage.src = characterPath;
            characterImage.onload = () => {
                if (isSpecial) {
                    // Disable color changes for special characters
                    disableColorPickers();
                } else {
                    // Enable color changes for regular characters
                    enableColorPickers();
                }
                drawCanvas();
            };
        }

        function disableColorPickers() {
            document.getElementById('skinColor').disabled = true;
            document.getElementById('hairColor').disabled = true;
            document.getElementById('shirtColor').disabled = true;
        }

        function enableColorPickers() {
            document.getElementById('skinColor').disabled = false;
            document.getElementById('hairColor').disabled = false;
            document.getElementById('shirtColor').disabled = false;
        }


        // Function to handle character upload
        function uploadCharacter(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Set the selected character image to the uploaded file
                    document.getElementById('character-image').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        characterImage.onload = () => {
            drawCanvas();
        };

        bgImage.onload = () => {
            drawCanvas();
        };

        // Filter application functions that modify image data directly
        function applyFilterToImageData(imageData, filterFunction) {
                    const data = imageData.data;
                    filterFunction(data);
                    return imageData;
                }

        function applyOldTimeyFilter(data) {
            const width = canvas.width;
            const height = canvas.height;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // Convert to grayscale
                const gray = 0.3 * r + 0.59 * g + 0.11 * b;

                // Apply sepia tone
                data[i] = gray * 0.9 + 35;   // Red channel
                data[i + 1] = gray * 0.7 + 20; // Green channel
                data[i + 2] = gray * 0.4;    // Blue channel

                // Apply noise (grain)
                const noise = (Math.random() - 0.5) * 20;
                data[i] += noise;
                data[i + 1] += noise;
                data[i + 2] += noise;

                // Clamp color values to [0, 255]
                data[i] = Math.min(255, Math.max(0, data[i]));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1]));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2]));
            }
        }

        function applyVintageFilter(data) {
            for (let i = 0; i < data.length; i += 4) {
                // Add random noise (grain)
                const noise = (Math.random() - 0.5) * 50;
                data[i] = Math.min(255, Math.max(0, data[i] + noise));         // Red channel
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise)); // Green channel
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise)); // Blue channel
            }
        }

        function applyRetroFilter(data) {
            const width = canvas.width;
            const height = canvas.height;

            // Create separate buffers for RGB channels to apply color channel separation
            const redChannel = new Uint8ClampedArray(data.length);
            const greenChannel = new Uint8ClampedArray(data.length);
            const blueChannel = new Uint8ClampedArray(data.length);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // Enhance colors
                data[i] = Math.min(255, r * 1.2 + 20); // Increase red channel and add shift
                data[i + 1] = Math.max(0, g * 1.1 - 10); // Increase green channel and subtract shift
                data[i + 2] = Math.max(0, b * 0.8 - 20); // Decrease blue channel and subtract shift

                // Add random noise (grain)
                const noise = (Math.random() - 0.5) * 30;
                data[i] = Math.min(255, Math.max(0, data[i] + noise));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));

                // Initialize channel buffers
                redChannel[i] = data[i];
                greenChannel[i + 1] = data[i + 1];
                blueChannel[i + 2] = data[i + 2];

                // Copy alpha channel
                redChannel[i + 3] = data[i + 3];
                greenChannel[i + 3] = data[i + 3];
                blueChannel[i + 3] = data[i + 3];
            }

            // Apply scan lines
            for (let y = 0; y < height; y++) {
                if (y % 3 === 0) { // Adjust the spacing of the scan lines
                    for (let x = 0; x < width; x++) {
                        const index = (y * width + x) * 4;
                        data[index] *= 0.5; // Darken the pixel
                        data[index + 1] *= 0.5;
                        data[index + 2] *= 0.5;
                    }
                }
            }
        }

        function applyBlackAndWhiteFilter(data) {
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
                data[i] = gray;
                data[i + 1] = gray;
                data[i + 2] = gray;
            }
        }

        function applySepiaFilter(data) {
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                data[i] = r * 0.393 + g * 0.769 + b * 0.189;
                data[i + 1] = r * 0.349 + g * 0.686 + b * 0.168;
                data[i + 2] = r * 0.272 + g * 0.534 + b * 0.131;
            }
        }

        function applyCoolFilter(data) {
            for (let i = 0; i < data.length; i += 4) {
                data[i] = data[i] * 0.9;
                data[i + 1] = data[i + 1] * 1.1;
                data[i + 2] = data[i + 2] * 1.2;
            }
        }

        function applyAnimeMangaFilter(data) {
            const width = canvas.width;
            const height = canvas.height;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // Convert to grayscale
                let gray = 0.3 * r + 0.59 * g + 0.11 * b;

                // Enhance contrast
                gray = (gray - 128) * 2 + 128;

                // Apply some noise to add texture
                const noise = (Math.random() - 0.5) * 20;
                gray += noise;

                // Apply a threshold effect but allow for intermediate grays
                gray = Math.round(gray / 32) * 32;

                data[i] = gray;     // Red channel
                data[i + 1] = gray; // Green channel
                data[i + 2] = gray; // Blue channel

            }

        }

        function applyVignetteFilter(data) {
            const width = canvas.width;
            const height = canvas.height;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const dx = (x - width / 2) / (width / 3 * 2);  // Adjust the divisor to make the vignette smaller
                    const dy = (y - height / 2) / (height / 3 * 2); // Adjust the divisor to make the vignette smaller
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const vignette = 1 - Math.pow(distance, 3); // Adjusting the power to make it more subtle

                    const index = (y * width + x) * 4;
                    data[index] *= vignette;
                    data[index + 1] *= vignette;
                    data[index + 2] *= vignette;
                }
            }
        }

        let currentFilter = null;

        // Main filter application function
        function applyFilter(filterName) {
            if (filterName == 'vignette') {
                toggleVignetteFilter();
            }
            currentFilter = filterName;
            drawCanvas();
        }

        function applyFilterToCanvas() {
            const canvasImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            if (currentFilter) {
                switch (currentFilter) {
                    case 'old-timey':
                        applyFilterToImageData(canvasImageData, applyOldTimeyFilter);
                        break;
                    case 'vintage':
                        applyFilterToImageData(canvasImageData, applyVintageFilter);
                        break;
                    case 'retro':
                        applyFilterToImageData(canvasImageData, applyRetroFilter);
                        break;
                    case 'black-and-white':
                        applyFilterToImageData(canvasImageData, applyBlackAndWhiteFilter);
                        break;
                    case 'sepia':
                        applyFilterToImageData(canvasImageData, applySepiaFilter);
                        break;
                    case 'cool':
                        applyFilterToImageData(canvasImageData, applyCoolFilter);
                        break;
                    case 'manga':
                        applyFilterToImageData(canvasImageData, applyAnimeMangaFilter)
                        break;
                    default:
                        return;
                }
            }

            if (vignetteEnabled) {
                applyVignetteFilter(canvasImageData.data);
            }

            ctx.putImageData(canvasImageData, 0, 0);
        }

        let vignetteEnabled = false;

        function toggleVignetteFilter() {
            vignetteEnabled = !vignetteEnabled;
            drawCanvas();
        }

        function applyVignetteFilterToCanvas() {
            const canvasImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            applyVignetteFilter(canvasImageData.data);
            ctx.putImageData(canvasImageData, 0, 0);
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw the background first
            if (useBgImage) {
                const { width, height, offsetX, offsetY } = getImageDimensions(bgImage, canvas.width, canvas.height);
                ctx.drawImage(bgImage, -offsetX, -offsetY, width, height);
            } else {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Separate lanterns from other accessories
            const lanterns = accessories.filter(accessory => accessory.image.src.includes('lanterns'));
            const otherAccessories = accessories.filter(accessory => !accessory.image.src.includes('lanterns'));

            // Draw lanterns (in front of the background but behind the character)
            lanterns.forEach(accessory => {
                const x = (canvas.width - characterImage.width * characterScale) / 2 + (characterImage.width * characterScale * accessory.originalX) / 100;
                const y = canvas.height - characterImage.height * characterScale + (characterImage.height * characterScale * accessory.originalY) / 100;
                const { width, height } = getAccessoryImageDimensions(accessory.image, characterImage.width * characterScale * accessory.scale, characterImage.height * characterScale * accessory.scale);

                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(x + width / 2, y + height / 2);
                ctx.rotate(accessory.angle * Math.PI / 180);
                ctx.drawImage(accessory.image, -width / 2, -height / 2, width, height);
                ctx.restore();
            });

            // Draw the character image
            if (characterImage.src) {
                const { width, height } = getCharacterImageDimensions(characterImage, canvas.width * characterScale, canvas.height * characterScale);
                const x = (canvas.width - width) / 2;
                const y = canvas.height - height;

                offscreenCanvas.width = canvas.width;
                offscreenCanvas.height = canvas.height;
                offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                offscreenCtx.drawImage(characterImage, x, y, width, height);
                imageData = offscreenCtx.getImageData(x, y, width, height);
                originalPixels = new Uint8ClampedArray(imageData.data);

                updateImage();
                ctx.drawImage(offscreenCanvas, 0, 0);

                drawAccessories(x, y, width, height, otherAccessories); // Pass only other accessories to draw

                // Highlight the selected accessory if one is selected
                if (selectedAccessory) {
                    drawSelectionOutline(selectedAccessory, x, y, width, height);
                }

                // Apply the currently selected filter to the entire canvas
                if (currentFilter) {
                    applyFilterToCanvas(currentFilter);
                }

                // Always apply vignette filter if it's enabled
                if (vignetteEnabled) {
                    applyVignetteFilterToCanvas();
                }
            } else if (vignetteEnabled) {
                // Apply vignette filter to the base background if no character image is selected
                applyVignetteFilterToCanvas();
            }
        }

        const scaleRange = document.getElementById('scaleRange');

        let characterScale = parseFloat(scaleRange.value);

        scaleRange.addEventListener('input', (event) => {
            characterScale = parseFloat(event.target.value);
            drawCanvas();
        });

        const drawCharacterImage = () => {
            const { width, height } = getCharacterImageDimensions(characterImage, canvas.width * characterScale, canvas.height * characterScale);
            const x = (canvas.width - width) / 2;
            const y = canvas.height - height;

            offscreenCanvas.width = canvas.width;
            offscreenCanvas.height = canvas.height;

            offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
            offscreenCtx.drawImage(characterImage, x, y, width, height);
            imageData = offscreenCtx.getImageData(x, y, width, height);
            originalPixels = new Uint8ClampedArray(imageData.data);
            updateImage();

            ctx.drawImage(offscreenCanvas, 0, 0);
        };

        let isSpecialCharacter = false; // Flag to track if a special character is selected

        function selectCharacter(characterPath, isSpecial) {
            characterImage.src = characterPath;
            characterImage.onload = () => {
                isSpecialCharacter = isSpecial;
                drawCanvas();
            };
        }

        function updateImage() {
            if (imageData) {
                imageData.data.set(originalPixels);

                const skinColor = hexToRgb(skinColorInput.value);
                const hairColor = hexToRgb(hairColorInput.value);
                const shirtColor = hexToRgb(shirtColorInput.value);

                for (let i = 0; i < originalPixels.length; i += 4) {
                    const r = originalPixels[i];
                    const g = originalPixels[i + 1];
                    const b = originalPixels[i + 2];
                    const a = originalPixels[i + 3];

                    if (a > 0) { // Only apply color shift if the pixel is not transparent

                        if (isEyeColor(r, g, b)) {
                            imageData.data[i] = 243;
                            imageData.data[i + 1] = 236;
                            imageData.data[i + 2] = 235;
                        } else if (!isSpecialCharacter) {
                            if (isSkinColor(r, g, b)) {
                                applyColorShift(i, skinColor);
                            } else if (isHairColor(r, g, b)) {
                                applyColorShift(i, hairColor);
                            } else if (isShirtColor(r, g, b) && i > (originalPixels.length * .63)) {
                                applyColorShift(i, shirtColor);
                            }
                        }
                    }
                }

                const x = (canvas.width - imageData.width) / 2;
                const y = canvas.height - imageData.height;
                offscreenCtx.putImageData(imageData, x, y);
            }
        }

        const hexToRgb = (hex) => {
            const bigint = parseInt(hex.slice(1), 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        };

        const applyColorShift = (index, color) => {
            imageData.data[index] = color.r;
            imageData.data[index + 1] = color.g;
            imageData.data[index + 2] = color.b;
        };

        const isEyeColor = (r, g, b) => {
            return (r > 115 && r < 150) && (g > 220) && (b > 220);
        };

        const isSkinColor = (r, g, b) => {
            return (r > 180 && r < 256) && (g > 180 && g < 256) && (b > 180 && b < 256);
        };

        const isHairColor = (r, g, b) => {
            return (r > 100 && r < 210) && (g < 65) && (b < 65);
        };

        const isShirtColor = (r, g, b) => {
            return (r > 150 && r < 190) && (g > 150 && g < 180) && (b > 150 && b < 180);
        };

        const getCharacterImageDimensions = (image, maxWidth, maxHeight) => {
            const aspectRatio = image.width / image.height;

            let width, height;
            if (maxWidth / maxHeight > aspectRatio) {
                height = maxHeight * 0.8 * characterScale;
                width = height * aspectRatio;
            } else {
                width = maxWidth * 0.8 * characterScale;
                height = width / aspectRatio;
            }
            return { width, height };
        };

        const getImageDimensions = (image, canvasWidth, canvasHeight) => {
            const imageAspectRatio = image.width / image.height;
            const canvasAspectRatio = canvasWidth / canvasHeight;

            let width, height, offsetX = 0, offsetY = 0;

            if (imageAspectRatio > canvasAspectRatio) {
                // Image is wider than canvas, crop the sides
                height = canvasHeight;
                width = height * imageAspectRatio;
                offsetX = (width - canvasWidth) / 2;
            } else {
                // Image is taller than canvas, crop the top and bottom
                width = canvasWidth;
                height = width / imageAspectRatio;
                offsetY = (height - canvasHeight) / 2;
            }

            return { width, height, offsetX, offsetY };
        };

        const saveCharacter = () => {
            drawCanvas(); // Ensure canvas is up-to-date
            const link = document.createElement('a');
            link.download = 'character.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        // Function to select a preset background
        function selectBackground(backgroundPath) {
            useBgImage = true; // Ensure the background image is used
            bgImage.src = backgroundPath;
            bgImage.onload = drawCanvas;
        }

        bgColorInput.addEventListener('input', (event) => {
            useBgImage = false; // Ensure the background color is used
            bgColor = event.target.value;
            drawCanvas();
        });

        skinColorInput.addEventListener('input', drawCanvas);
        hairColorInput.addEventListener('input', drawCanvas);
        shirtColorInput.addEventListener('input', drawCanvas);
        saveBtn.addEventListener('click', saveCharacter);

        // Initial background color update
        drawCanvas();


    </script>

    <script>
        function enableDragScroll(containerSelector) {
            const containers = document.querySelectorAll(containerSelector);
            
            containers.forEach(container => {
                let isDown = false;
                let startX, startY, scrollLeft, scrollTop;

                container.addEventListener('mousedown', (e) => {
                    isDown = true;
                    container.classList.add('active');
                    startX = e.pageX - container.offsetLeft;
                    startY = e.pageY - container.offsetTop;
                    scrollLeft = container.scrollLeft;
                    scrollTop = container.scrollTop;
                    e.preventDefault();
                });

                container.addEventListener('mouseleave', () => {
                    isDown = false;
                    container.classList.remove('active');
                });

                container.addEventListener('mouseup', () => {
                    isDown = false;
                    container.classList.remove('active');
                });

                container.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - container.offsetLeft;
                    const y = e.pageY - container.offsetTop;
                    const walkX = (x - startX) * 2; // Adjust scroll speed as needed
                    const walkY = (y - startY) * 2; // Adjust scroll speed as needed
                    container.scrollLeft = scrollLeft - walkX;
                    container.scrollTop = scrollTop - walkY;
                });
            });
        }

        // Call the function for your specific containers
        enableDragScroll('.horizontal-scroll-container');
        enableDragScroll('.filters-wrapper');
        enableDragScroll('.accessories-wrapper');
    </script>

</body>
</html>